<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<title>Test Lehrer</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
	<script src="scripts/vendor/sha512.min.js"></script>
	<script src="scripts/vendor/dexie.min.js"></script>

</head>
<body>
<div id="loginFormular">
	<label for="sean">Schülerausweis-/Lehrernummer:</label>
	<input type="text" name="sean" id="sean" value="260000002"><br/>
	<label for="passwort">Passwort:</label>
	<input type="password" name="passwort" id="passwort">
	<label for="autoLogin">angemeldet bleiben:</label>
	<input type="checkbox" checked name="autoLogin" id="autoLogin">
	<input type="submit" value="anmelden" id="loginButton">
</div>
</body>
<script type="application/javascript">
	var urlLogin = 'http://vapp.niemoeller.schule/api/index.php';
	//var urlLogin = 'http://127.0.1.5/index.php';
	var loggedIn = false;

	var db = new Dexie("Einstellungen");
	db.version(1).stores({config:'key,value'});
	// Testdaten holen
	$.ajax({
		url: urlLogin,
		dataType: 'json',
		crossDomain: true,
		data: 'fname=testL&sean=NN&pw=' +
		'7c80a8a270caf88e1229c774c301178986c1036e0b242432d8d9f317c2423efa9692c2bb274c674457b623179f193d8cfbc73cf34bde3312f3132c53235f16cc',
		success: function(response){
			// Testdaten abspeichern
			db.config.clear();
			db.config.put({key:'sean', value:sean});
			db.config.put({key:'pw', value:passwort});
			db.config.put({key:'loginType', value:'test'});
			db.config.put({key:'autoLogin', value: true});
			handleLogin(response);
			loggedIn = true;
		},
		error: function (response,textStatus,e) {
			console.debug('Test Lehrer: kein login auf dem Server möglich', textStatus, e);
		}
	});


	/**
	 *
	 * wie in main.js
	 * Anmerkung: das ist nicht schön programmiert, denn immer wenn sich die Funktion in main.js ändert, sollte sie sich
	 * auch hier ändern.
	 *
	 * das Login wurde ausgeführt und liefert Daten
	 * diese Daten werden in der lokalen Datenbank abgelegt
	 * - Stundenplan
	 * - Vertretungesplan
	 * @param antwort -> JSON-Objekt mit der Rückgabe der bisher relevanten Daten
	 *  dabei wird zwischen Lehrern und Schülern unterschieden
	 */
	function handleLogin(antwort) {
		console.debug(antwort);
		// Login war erfolgreich -> Datum des Login speichern
		db.transaction('rw', db.config, function () {
			db.config.put({key: 'loginDate', value: new Date()});
			// Daten in die lokale Datenbank eintragen (falls vorhanden - unterscheidet sich für Schüler und Lehrer)
			if (antwort.login == 'test') {
				if ('splan' in antwort) {
					db.config.put({key: 'splan', value: antwort.splan});
				}
				if ('vplan' in antwort) {
					db.config.put({key: 'vplan', value: antwort.vplan});
				}
				if ('vplanAlle' in antwort) {
					db.config.put({key: 'vplanAlle', value: antwort.vplanAlle});
				}
				if ('buecher' in antwort) {
					db.config.put({key: 'buecher', value: antwort.buecher});
				}
				if ('klausuren' in antwort) {
					db.config.put({key: 'klausuren', value: antwort.klausuren});
				}
				if ('kursliste' in antwort) {
					db.config.put({key: 'kursliste', value: antwort.kursliste});
				}
			} else console.debug('Login-Fehler: ok erwartet: ' + antwort);
		}).then(function () {
			// verstecke das Login-Formular - hier nur wenn auch die Antwort mit "ok" bestätigt wurde
			$('#loginFormular').hide();
			window.location = "./stundenplan.html";
		}).catch(function (e) {
			console.error('handleLogin:', e, e.stack);
		});
	};
</script>
</html>